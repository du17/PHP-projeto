-- ex1

create view nao_mais_que_3 as
select distinct Nome_livro, emprestado_atualmente, numero_emprestimos from emprestimos
inner join livros on emprestimos.id_livro = livros.id_livro
where numero_emprestimos > 3

-----------------------------------------------------------------

-- ex2

drop trigger Tg_emprestimo_Insert

DELIMITER $
CREATE TRIGGER Tg_emprestimo_Insert AFTER INSERT
ON emprestimos
FOR EACH ROW
BEGIN
   UPDATE livros SET livros.emprestado_atualmente = livros.emprestado_atualmente = 'NÃ£o'
   WHERE OLD.emprestimos.data_emprestimo = NEW.emprestimos.data_emprestimo = null;
END$
DELIMITER ;

insert into emprestimos (ID_cliente,id_livro,data_emprestimo,data_devolucao)
values 
(10,7,current_date(),null);

--------------------------------------------------------------------

-- ex3

-- a)

select nome_editora from emprestimos
inner join livros on emprestimos.id_livro = livros.id_livro
inner join editoras on livros.id_editora = editoras.id_editora
where data_emprestimo = ('2025-05-12')

-- b)

select nome_cliente, nome_livro, emprestado_atualmente from clientes
inner join emprestimos on clientes.id_cliente = emprestimos.id_cliente
inner join livros on emprestimos.id_livro = livros.id_livro
where nome_livro = 'O nome da Rosa'

-- c)

select nome_livro, numero_emprestimos from livros
where numero_emprestimos = 0

-- d)

select nome_livro from livros
where nome_livro like '%server%'

-- e)

select nome_cliente, sobrenome_cliente from clientes
where nome_cliente like '%d'

-- f)



select nome_livro, nome_editora, preco_livro, preco_livro * 1.05 from livros
inner join editoras on livros.id_editora = editoras.id_editora
where nome_editora = 'Prentice hall'

-----------------------------------------------------------------

-- ex4

SET GLOBAL log_bin_trust_function_creators = 1;

DELIMITER //
CREATE FUNCTION Fc_ano(n1 smallint)
    RETURNS smallint
    Begin
    
      declare default(0);
      select sum(*) into qtde from emprestimo
        where emprestimo.ID_Livro = p_id_livro and
        month(emprestimo.data_emprestimo) = year(datacorrente());
        
	return qtde;
    end//

DELIMITER ;

-- comando para teste
select fc_ano(trocar_pelo_id_livro);